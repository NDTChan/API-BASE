create or replace procedure PHA_NS_BM56_ND31_TH(P_CONGTHUC VARCHAR2, P_NAM VARCHAR2, P_CAP VARCHAR2, DONVI_TIEN number, cur OUT SYS_REFCURSOR) as
   QUERY_STR   CLOB; 
   P_CT  VARCHAR2(32767);    
   P_SQL_INSERT  VARCHAR2(32767); 
   TEMP  VARCHAR2(32767);
   BEGIN
    IF TRIM(P_CONGTHUC) IS NOT NULL THEN 
        select STC_PA_SYS.FNC_CONVERT_FORMULA_HCSN(P_CONGTHUC) INTO P_CT from dual;       
        P_CT:= ' AND ' || P_CT;
    END IF;
            CASE 
                WHEN P_CAP='2' THEN TEMP:=' AND A.MA_CHUONG BETWEEN ''400'' AND ''989''';
                WHEN P_CAP='3' THEN TEMP:=' AND A.MA_CHUONG BETWEEN ''600'' AND ''989''';
                WHEN P_CAP='4' THEN TEMP:=' AND A.MA_CHUONG BETWEEN ''800'' AND ''989''';
                ELSE TEMP:='';
            END CASE;

            QUERY_STR:='SELECT HT.MA_CHUONG, HT.TEN_CHUONG
                        , NVL(HT.DUTOAN,0) as DUTOAN
                        , NVL(HT.GIAODUC,0) as GIAODUC , NVL(HT.KHCN,0) as KHCN , NVL(HT.QUOCPHONG,0) as QUOCPHONG
                        , NVL(HT.ANNINH,0) as ANNINH , NVL(HT.YTE,0) as YTE , NVL(HT.VHTT,0) as VHTT, NVL(HT.PTTT,0) as PTTT, NVL(HT.TDTT,0) as TDTT, NVL(HT.BVMT,0) as BVMT
                        , NVL(HT.HDKT,0) as HDKT, NVL(HT.HDKT_GT,0) as HDKT_GT, NVL(HT.HDKT_NLTL,0) as HDKT_NLTL, NVL(HT.QLNN,0) as QLNN, NVL(HT.BDXH,0) as BDXH, NVL(HT.CK,0) as CK                      
                        FROM
                        (
                        SELECT A.MA_CHUONG AS MA_CHUONG, A.TEN_CHUONG
                        ,NVL(SUM (CASE WHEN (( MA_TKTN like ''9523'' OR  MA_TKTN like ''9257'' AND  ATTRIBUTE8 like ''01'')) THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS DUTOAN

                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND   MA_LOAI like ''490'' AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC  BETWEEN  ''9200'' AND ''9400'')  AND NOT   MA_CTMTQG like ''00956'')) 
                                    THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS GIAODUC
                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''1912'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8913'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'') AND ( MA_LOAI like ''370'') AND ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC like ''9200'' OR  MA_MUC like ''9250'' OR  MA_MUC like ''9300'' OR  MA_MUC like ''9350'' OR  MA_MUC like ''9400'' OR  MA_MUC like ''8050'' OR  MA_MUC like ''8100'' OR  MA_MUC like ''8750'' OR  MA_MUC like ''8800'' OR  MA_MUC like ''8950'') AND NOT  MA_CTMTQG like ''00956'') OR  (( MA_TKTN like ''8959'' OR  MA_TKTN like ''1919'' OR  MA_TKTN like ''8919'') AND ( MA_LOAI like ''370'') AND ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'') AND NOT  MA_CTMTQG like ''00956'')) 
                                  THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS KHCN

                       ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''8959'' OR  MA_TKTN like ''1919'' OR  MA_TKTN like ''8919'') AND  MA_NGANHKT like ''468''  AND NOT ( MA_MUC like ''7200'' OR  MA_MUC like ''7400'' OR  MA_MUC like ''9700'' OR  MA_MUC like ''9100'' OR  MA_MUC like ''9200'' OR  MA_MUC like ''9250'' OR  MA_MUC like ''9300'' OR  MA_MUC like ''9350'' OR  MA_MUC like ''9400'')  AND NOT   MA_CTMTQG like ''00956'' ) OR  (( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''1912'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8913'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND   ( MA_NGANHKT like ''468'') AND NOT ( MA_MUC like ''7200'' OR  MA_MUC like ''7400'' OR  MA_MUC like ''9700'')  AND NOT   MA_CTMTQG like ''00956'')) 
                                 THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS QUOCPHONG

                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''1523'' OR  MA_TKTN like ''1511'' OR  MA_TKTN like ''1521'' OR  MA_TKTN like ''1912'' OR  MA_TKTN like ''81%'' OR  MA_TKTN like ''8913'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND  ( MA_NGANHKT like ''471'')  AND NOT  ( MA_MUC like ''7200'' OR  MA_MUC like ''7400'' OR  MA_MUC like ''9700'')) OR  ( MA_TKTN like ''8959'' OR  MA_TKTN like ''1919'' OR  MA_TKTN like ''8919'')  AND  ( MA_NGANHKT like ''471'')  AND NOT  ( MA_MUC like ''7200'' OR  MA_MUC like ''7400'' OR  MA_MUC like ''9700'' OR  MA_MUC like ''9100'' OR   MA_MUC  BETWEEN  ''9200'' AND ''9400'')) 
                                THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS ANNINH

                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND  ( MA_LOAI like ''520''  AND NOT ( MA_NGANHKT like ''524'' OR  MA_NGANHKT like ''525'' OR  MA_NGANHKT like ''527'' OR  MA_NGANHKT like ''528'' OR  MA_NGANHKT like ''531'')) AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC  BETWEEN  ''9200'' AND ''9400'')  AND NOT   MA_CTMTQG like ''00956'')   OR   ( MA_TKTN like ''8959''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'')  AND  ( MA_LOAI like ''520''  AND NOT ( MA_NGANHKT like ''524'' OR  MA_NGANHKT like ''525'' OR  MA_NGANHKT like ''527'' OR  MA_NGANHKT like ''528'' OR  MA_NGANHKT like ''531''))  AND NOT   MA_CTMTQG like ''00956'')) 
                                THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS YTE

                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''8959'' OR  MA_TKTN like ''1919'' OR  MA_TKTN like ''8919'') AND ( MA_LOAI like ''550'') AND NOT ( MA_NGANHKT like ''558'' OR  MA_NGANHKT like ''561'' OR  MA_NGANHKT like ''562'') AND ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'')  AND NOT   MA_CTMTQG like ''00956'') OR   (( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''1912'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8913'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'') AND  MA_LOAI like ''550'' AND NOT ( MA_NGANHKT like ''558'' OR  MA_NGANHKT like ''561'' OR  MA_NGANHKT like ''562'') AND ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC like ''9200'' OR  MA_MUC like ''9250'' OR  MA_MUC like ''9300'' OR  MA_MUC like ''9350'' OR  MA_MUC like ''9400'' OR  MA_MUC like ''8050'' OR  MA_MUC like ''8100'' OR  MA_MUC like ''8750'' OR  MA_MUC like ''8800'' OR  MA_MUC like ''8950'') AND NOT  MA_CTMTQG like ''00956'')) 
                                THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS VHTT

                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''1912'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8913'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'') AND ( MA_NGANHKT like ''252'' OR  MA_NGANHKT like ''253'' OR  MA_NGANHKT like ''254'') AND ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC like ''9200'' OR  MA_MUC like ''9250'' OR  MA_MUC like ''9300'' OR  MA_MUC like ''9350'' OR  MA_MUC like ''9400'' OR  MA_MUC like ''8050'' OR  MA_MUC like ''8100'' OR  MA_MUC like ''8750'' OR  MA_MUC like ''8800'' OR  MA_MUC like ''8950'') AND NOT  MA_CTMTQG like ''00956'') OR  ( ( MA_TKTN like ''8959'' OR  MA_TKTN like ''1919'' OR  MA_TKTN like ''8919'') AND ( MA_NGANHKT like ''252'' OR  MA_NGANHKT like ''253'' OR  MA_NGANHKT like ''254'') AND ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'') AND NOT  MA_CTMTQG like ''00956'')) 
                                THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS PTTT

                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND   MA_NGANHKT like ''562''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC  BETWEEN  ''9200'' AND ''9400'')  AND NOT   MA_CTMTQG like ''00956'')  OR  ( MA_TKTN like ''8959''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'')  AND   MA_NGANHKT like ''562''  AND NOT   MA_CTMTQG like ''00956'')) 
                                THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS TDTT

                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND   MA_LOAI like ''280''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC  BETWEEN  ''9200'' AND ''9400'')  AND NOT   MA_CTMTQG like ''00956'')  OR  ( MA_TKTN like ''8959''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'')  AND   MA_LOAI like ''280''  AND NOT   MA_CTMTQG like ''00956''))
                                THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS BVMT 

                        ,NVL(SUM (CASE WHEN (((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND    MA_LOAI like ''220''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC  BETWEEN  ''9200'' AND ''9400'')  AND NOT   MA_CTMTQG like ''00956'')  OR  ( MA_TKTN like ''8959''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'')  AND   MA_LOAI like ''220''  AND NOT   MA_CTMTQG like ''00956'')) OR ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND   ( MA_NGANHKT  BETWEEN  ''011'' AND ''021'' OR    MA_NGANHKT like ''024'')  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC  BETWEEN  ''9200'' AND ''9400'')  AND NOT   MA_CTMTQG like ''00956'')  OR  (( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND    MA_CHUONG like ''012''  AND  ( MA_NGANHKT  BETWEEN  ''011'' AND ''021'' OR    MA_NGANHKT like ''024'')  AND   MA_MUC like ''8800''  AND NOT   MA_CTMTQG like ''00956'')  OR  ( MA_TKTN like ''8959''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'')  AND  ( MA_NGANHKT  BETWEEN  ''011'' AND ''021'' OR    MA_NGANHKT like ''024'')  AND NOT   MA_CTMTQG like ''00956'')  OR  ( MA_TKTN like ''8959''  AND   MA_TIEUMUC like ''8052''  AND   MA_NGANHKT like ''016''  AND NOT   MA_CTMTQG like ''00956'')) OR ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND   ((( MA_LOAI like ''040'' OR  MA_LOAI like ''070'' OR  MA_LOAI like ''130'' OR  MA_LOAI like ''160'' OR  MA_LOAI like ''190'' OR  MA_LOAI like ''250'' OR  MA_LOAI like ''310'' OR  MA_LOAI like ''400'' OR  MA_LOAI like ''430'') OR ( MA_NGANHKT like ''558'' OR  MA_NGANHKT like ''561'' OR  MA_NGANHKT like ''582'' OR  MA_NGANHKT like ''583''))  AND NOT   MA_NGANHKT  BETWEEN  ''252'' AND ''254'')  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC  BETWEEN  ''9200'' AND ''9400'')  AND NOT   MA_CTMTQG like ''00956'')  OR  ( MA_TKTN like ''8959''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'')  AND  ((( MA_LOAI like ''040'' OR  MA_LOAI like ''070'' OR  MA_LOAI like ''130'' OR  MA_LOAI like ''160'' OR  MA_LOAI like ''190'' OR  MA_LOAI like ''250'' OR  MA_LOAI like ''310'' OR  MA_LOAI like ''400'' OR  MA_LOAI like ''430'') OR ( MA_NGANHKT like ''558'' OR  MA_NGANHKT like ''561'' OR  MA_NGANHKT like ''582'' OR  MA_NGANHKT like ''583''))  AND NOT   MA_NGANHKT  BETWEEN  ''252'' AND ''254'')  AND NOT   MA_CTMTQG like ''00956''))) 
                                THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS HDKT

                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND    MA_LOAI like ''220''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC  BETWEEN  ''9200'' AND ''9400'')  AND NOT   MA_CTMTQG like ''00956'')  OR  ( MA_TKTN like ''8959''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'')  AND   MA_LOAI like ''220''  AND NOT   MA_CTMTQG like ''00956'')) 
                                THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS HDKT_GT

                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND   ( MA_NGANHKT  BETWEEN  ''011'' AND ''021'' OR    MA_NGANHKT like ''024'')  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC  BETWEEN  ''9200'' AND ''9400'')  AND NOT   MA_CTMTQG like ''00956'')  OR  (( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND    MA_CHUONG like ''012''  AND  ( MA_NGANHKT  BETWEEN  ''011'' AND ''021'' OR    MA_NGANHKT like ''024'')  AND   MA_MUC like ''8800''  AND NOT   MA_CTMTQG like ''00956'')  OR  ( MA_TKTN like ''8959''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'')  AND  ( MA_NGANHKT  BETWEEN  ''011'' AND ''021'' OR    MA_NGANHKT like ''024'')  AND NOT   MA_CTMTQG like ''00956'')  OR  ( MA_TKTN like ''8959''  AND   MA_TIEUMUC like ''8052''  AND   MA_NGANHKT like ''016''  AND NOT   MA_CTMTQG like ''00956'')) 
                                THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS HDKT_NLTL

                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND   ( MA_NGANHKT  BETWEEN  ''461'' AND ''467'' OR   MA_NGANHKT like ''472'' OR  MA_NGANHKT like ''473'' OR  MA_NGANHKT like ''489'')  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC  BETWEEN  ''9200'' AND ''9400'')  AND NOT   MA_CTMTQG like ''00956'')  OR  ( MA_TKTN like ''8959''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'')  AND   MA_NGANHKT  BETWEEN  ''461'' AND ''467''  AND NOT   MA_CTMTQG like ''00956''))
                                THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS QLNN

                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''1912'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8913'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'') AND ( MA_NGANHKT like ''474'' OR  MA_NGANHKT like ''524'' OR  MA_NGANHKT like ''525'' OR  MA_NGANHKT like ''527'' OR  MA_NGANHKT like ''528'' OR  MA_NGANHKT like ''531'') AND ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC like ''9200'' OR  MA_MUC like ''9250'' OR  MA_MUC like ''9300'' OR  MA_MUC like ''9350'' OR  MA_MUC like ''9400'' OR  MA_MUC like ''8050'' OR  MA_MUC like ''8100'' OR  MA_MUC like ''8750'' OR  MA_MUC like ''8800'' OR  MA_MUC like ''8950'') AND NOT ( MA_CTMTQG like ''00956'' OR  MA_CTMTQG like ''00030''))  OR   ( ( MA_TKTN like ''8959'' OR  MA_TKTN like ''1919'' OR  MA_TKTN like ''8919'') AND ( MA_NGANHKT like ''474'' OR  MA_NGANHKT like ''524'' OR  MA_NGANHKT like ''525'' OR  MA_NGANHKT like ''527'' OR  MA_NGANHKT like ''528'' OR  MA_NGANHKT like ''531'') AND ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'') AND NOT ( MA_CTMTQG like ''00956'' OR  MA_CTMTQG like ''00030'')))
                                THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS BDXH

                        ,NVL(SUM (CASE WHEN ((( MA_TKTN like ''1513'' OR  MA_TKTN like ''1516'' OR  MA_TKTN like ''1523'' OR  MA_TKTN like ''1526'' OR  MA_TKTN like ''8113'' OR  MA_TKTN like ''8116'' OR  MA_TKTN like ''8123'' OR  MA_TKTN like ''8126'' OR  MA_TKTN like ''8953'' OR  MA_TKTN like ''8954'' OR  MA_TKTN like ''8955'' OR  MA_TKTN like ''8951'')  AND   ( MA_LOAI like ''340'' OR  MA_LOAI like ''581'' OR  MA_LOAI like ''610'' OR  MA_LOAI like ''640'')  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7900'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'' OR  MA_MUC  BETWEEN  ''9200'' AND ''9400'')  AND NOT   MA_CTMTQG like ''00956'')  OR  ( MA_TKTN like ''8959''  AND  ( MA_MUC  BETWEEN  ''6000'' AND ''7150'' OR  MA_MUC like ''7250'' OR  MA_MUC like ''7750'' OR  MA_MUC like ''7850'' OR  MA_MUC like ''7950'' OR  MA_MUC like ''8000'' OR  MA_MUC like ''8150'' OR  MA_MUC like ''9000'' OR  MA_MUC like ''9050'')  AND  ( MA_LOAI like ''340'' OR  MA_LOAI like ''581'' OR  MA_LOAI like ''610'' OR  MA_LOAI like ''640'')  AND NOT   MA_CTMTQG like ''00956'') OR  ( MA_TKTN like ''8993''  AND   MA_TIEUMUC like ''7551'')) 
                                THEN A.GIA_TRI_HACH_TOAN/NVL('|| DONVI_TIEN ||',1) ELSE 0 END),0) AS CK 


                        FROM PHA_HACHTOAN_CHI A
                        WHERE A.NGAY_HIEU_LUC >= TO_DATE ('''|| '0101' || P_NAM  ||''', ''ddMMyyyy'')
                        AND A.NGAY_HIEU_LUC <= TO_DATE ('''|| '3112' || P_NAM  ||''', ''ddMMyyyy'')
                        AND NOT A.MA_CAP like ''1'' AND NOT A.MA_CHUONG LIKE ''000'' '
                        || TEMP
                        || P_CT
                        || ' GROUP BY A.MA_CHUONG,A.TEN_CHUONG
                        ) HT
                        WHERE 1=1 ORDER BY HT.MA_CHUONG';


--DBMS_OUTPUT.put_line(QUERY_STR); 

BEGIN
EXECUTE IMMEDIATE QUERY_STR;
OPEN cur FOR QUERY_STR;
EXCEPTION
  WHEN NO_DATA_FOUND
  THEN
     DBMS_OUTPUT.put_line ('<your message>' || SQLERRM);
   WHEN OTHERS
   THEN
    --DBMS_OUTPUT.ENABLE(200000);
     DBMS_OUTPUT.put_line ('<your message>'  || SQLERRM); 
END;   
END PHA_NS_BM56_ND31_TH;