create or replace PACKAGE BODY       STC_PA_SYS
AS
  FUNCTION FNC_GET_TEN_DM(
      TAB_NAME IN VARCHAR,
      F_NAME VARCHAR,
      F_CODE VARCHAR,
      S_VALUE IN VARCHAR,
      EFF_DATE DATE)
    RETURN NVARCHAR2
  IS
    V_Return_Val NVARCHAR2 (500);
    V_Sql VARCHAR (2000);
    P_RESULT SYS_REFCURSOR;
  BEGIN
    V_Sql := ' Select ' || F_NAME
    --|| ' into V_Return_Val'
    || ' From ' || TAB_NAME || ' Where 1=1 ' || ' And ' || ' TRANG_THAI = ' || CHR (39) || 'A' || CHR (39) || ' And ' || F_CODE || ' = ' || CHR (39) || S_VALUE || CHR (39) || ' And Ngay_HL = ( Select max(Ngay_HL) from ' || TAB_NAME || ' Where 1=1 And ' || F_CODE || ' = ' || CHR (39) || S_VALUE || CHR (39) || ' And Ngay_HL <= TO_DATE(' || CHR (39) || TO_CHAR(EFF_DATE,'yyyyMMdd') || CHR (39) || ',' || CHR (39) || 'yyyyMMdd' || CHR (39) || '))';
    OPEN P_RESULT FOR V_Sql;
    LOOP
      FETCH P_RESULT INTO V_Return_Val;
      EXIT
    WHEN P_RESULT%NOTFOUND;
    END LOOP;
    RETURN V_Return_Val;
    --Execute immediate V_Sql;
  EXCEPTION
  WHEN OTHERS THEN
    NULL;
    --DBMS_OUTPUT.PUT_LINE ('Lỗi: ' || V_Sql);
    --DBMS_OUTPUT.PUT_LINE ('Lỗi: ' || V_Sql);
    RETURN V_Return_Val;
  END;
  FUNCTION FNC_GET_DICTIONARY(
      F_NAME   VARCHAR,
      F_CODE   VARCHAR,
      EFF_DATE DATE)
    RETURN NVARCHAR2
  IS
    V_Return_Val NVARCHAR2 (500);
  BEGIN
    SELECT Mo_ta
    INTO V_Return_Val
    FROM Sys_TuDien
    WHERE 1        = 1
    AND TRANG_THAI = 'A'
    AND FIELDNAME  = CHR (39)
      || F_NAME
      || CHR (39)
    AND MA_TUDIEN = F_CODE
    AND NGAY_HL   =
      (SELECT MAX (NGAY_HL)
      FROM Sys_TuDien
      WHERE 1       = 1
      AND FIELDNAME = CHR (39)
        || F_NAME
        || CHR (39)
      AND MA_TUDIEN = F_CODE
      AND NGAY_HL  <= EFF_DATE
      );
    RETURN V_Return_Val;
  END;
  FUNCTION FNC_GET_CONVERT_NDKT2NHOM(
      F_NDKT NVARCHAR2)
    RETURN NVARCHAR2
  IS
  BEGIN
    IF (LENGTH (TRIM (F_NDKT)) = 0) THEN
      RETURN '';
    END IF;
    IF (INSTR ( '0050,0051,0052,0053,0054,0055,0056,0057,0058,0061,0062,0063,0064,0065,0099,', F_NDKT || ',') > 0) THEN
      RETURN 'AAAA';
    END IF;
    IF (INSTR ('0001,0002,0003,0004,0005,0006,0007,0008,0011,0012,0049,', F_NDKT || ',') > 0) THEN
      RETURN 'BBBB';
    END IF;
    IF (INSTR ( '0800,0801,0802,0803,0804,0805,0806,0807,0808,0811,0812,0813,0814,0817,0818,0819,0820,0821,0822,0823,0824,0825,0826,0827,0828,0831,0832,0833,0834,0835,0839,', F_NDKT || ',') > 0) THEN
      RETURN 'CCCC';
    END IF;
    IF (INSTR ( '0840,0841,0842,0843,0844,0859,0860,0861,0862,0863,0864,0879,0880,0881,0882,0883,0884,0899,', F_NDKT || ',') > 0) THEN
      RETURN 'DDDD';
    END IF;
    IF (INSTR ('0900,0901,0902,0903,0904,', F_NDKT || ',') > 0) THEN
      RETURN 'EEEE';
    END IF;
    IF (INSTR ('0121,0950,0951,0952,0953,0954,', F_NDKT || ',') > 0) THEN
      RETURN 'FFFF';
    END IF;
    IF (INSTR (
      '0110,0111,0112,0113,0114,0118,0122,1000,1001,1002,1003,1004,1005,1006,1007,1008,1011,1012,1013,1014,1049,1050,1051,1052,1053,1054,1055,1056,1057,1058,1099,1100,      
1101,1102,1103,1149,1150,1151,1152,1153,1199,1250,1251,1300,1301,1302,1349,1350,1351,1352,1353,1354,1399,1400,1401,1402,1403,1404,1405,1406,1449,1450,1451,1499,1500,1501,1502,      
1503,1549,1550,1551,1552,1553,1554,1555,1556,1557,1558,1561,1562,1563,1599,1600,1601,1602,1603,1649,1700,1701,1702,1703,1704,1705,1749,1750,1751,1752,1753,1754,1755,1756,1757,      
1758,1761,1762,1763,1764,1765,1766,1767,1799,1800,1801,1802,1803,1804,1805,1806,1849,1850,1851,1852,1899,1900,1901,1902,1903,1949,1950,1951,1952,1953,1999,2000,2001,2002,2003,      
2004,2005,2006,2007,2008,2009,2019,2031,2032,2033,2034,2035,2036,2037,2038,2039,2041,2042,2043,2044,2045,2049,2100,2101,2102,2103,2104,2105,2106,2107,2108,2111,2150,2151,2152,      
2153,2154,2155,2156,2157,2158,2161,2162,2163,2164,2165,2166,2167,2200,2201,2202,2203,2204,2205,2206,2207,2208,2211,2250,2251,2252,2253,2254,2255,2256,2257,2258,2261,2262,2263,      
2264,2265,2266,2267,2300,2301,2302,2303,2304,2305,2306,2307,2308,2311,2312,2313,2314,2315,2316,2317,2318,2321,2322,2323,2324,2350,2351,2352,2353,2354,2355,2356,2357,2358,2361,      
2362,2363,2364,2365,2366,2367,2368,2400,2401,2402,2403,2404,2405,2406,2407,2408,2411,2412,2413,2414,2415,2416,2417,2418,2421,2422,2450,2451,2452,2453,2454,2455,2456,2457,2458,      
2500,2501,2502,2503,2504,2505,2506,2507,2508,2511,2512,2513,2550,2551,2552,2553,2554,2555,2556,2557,2558,2561,2562,2563,2564,2565,2566,2567,2600,2601,2602,2603,2604,2605,2606,      
2607,2608,2611,2612,2613,2614,2615,2616,2617,2618,2621,2622,2623,2624,2625,2626,2627,2628,2631,2632,2633,2634,2635,2636,2637,2650,2651,2652,2653,2654,2655,2656,2657,2658,2661,      
2662,2663,2664,2665,2700,2701,2702,2703,2704,2705,2706,2707,2708,2711,2712,2713,2714,2715,2716,2717,2718,2721,2722,2750,2751,2752,2753,2754,2755,2756,2757,2758,2761,2762,2763,      
2764,2765,2766,2767,2768,2771,2772,2773,2774,2800,2801,2802,2803,2804,2805,2806,2807,2808,2811,2812,2813,2814,2815,2816,2817,2818,2821,2822,2823,2824,2825,2826,2827,2828,2831,      
2850,2851,2852,2853,2854,2855,2856,2857,2858,2861,2862,2863,2864,2865,2866,2867,2868,2871,2872,3000,3001,3002,3003,3004,3005,3006,3007,3008,3009,3050,3051,3052,3053,3054,3055,      
3057,3058,3061,3062,3063,3064,3065,3066,3067,3068,3071,3072,3073,'
      , F_NDKT || ',') > 0) THEN
      RETURN '0110';
    END IF;
    IF (INSTR (
      '0115,0116,0117,0120,0200,3200,3201,3202,3203,3204,3249,3250,3251,3252,3253,3254,3299,3300,3301,3302,3349,3350,3351,3352,3353,3354,3355,3356,3357,3358,3361,3362,3363,      
3364,3365,3399,3400,3401,3402,3403,3404,3405,3406,3449,3450,3451,3452,3453,3499,3600,3601,3602,3603,3604,3605,3606,3607,3608,3649,3650,3651,3652,3653,3654,3699,3700,3701,3702,3703,      
3704,3705,3706,3749,3750,3751,3752,3753,3754,3755,3799,3800,3801,3802,3803,3849,3850,3851,3852,3853,3854,3899,3900,3901,3902,3903,3949,3950,3951,3952,3953,3954,3955,3999,4050,4051,      
4052,4053,4054,4099,4100,4101,4102,4103,4104,4149,4250,4251,4252,4253,4254,4255,4256,4257,4258,4261,4262,4263,4264,4265,4266,4267,4268,4271,4272,4273,4274,4275,4299,4300,4301,4302,      
4303,4304,4305,4306,4307,4308,4311,4312,4313,4349,4450,4451,4499,4500,4501,4502,4503,4504,4505,4506,4507,4549,4650,4651,4652,4653,4654,4655,4699,4700,4701,4702,4703,4749,4750,4751,      
4800,4801,4850,4851,4900,4901,4902,4903,4904,4905,4906,4907,4908,4917,4911,4912,4913,4914,4949,4918,4927,4928,4931,4935,4936,4943,4944,4947,'
      , F_NDKT || ',') > 0) THEN
      RETURN '0200';
    END IF;
    IF (INSTR ( '0123,0300,5050,5051,5052,5053,5054,5099,5100,5101,5102,5103,5104,5149,5150,5151,5152,5153,5154,5199,5200,5201,5202,5203,5204,5249,', F_NDKT || ',') > 0) THEN
      RETURN '0300';
    END IF;
    IF (INSTR ( '0124,0125,0126,0400,5350,5351,5352,5399,5450,5451,5452,5453,5499,5550,5551,5552,', F_NDKT || ',') > 0) THEN
      RETURN '0400';
    END IF;
    IF (INSTR (
      '0129,0130,0131,0132,0133,0500,6000,6001,6002,6003,6004,6049,6050,6051,6099,6100,6101,6102,6103,6104,6105,6106,6107,6108,6111,6112,6113,6114,6115,6116,6117,6118,6121,6122,      
6123,6124,6125,6149,6150,6151,6152,6153,6154,6155,6199,6200,6201,6202,6203,6249,6250,6251,6252,6253,6254,6255,6256,6257,6299,6300,6301,6302,6303,6304,6349,6350,6351,6352,6353,6399,      
6400,6401,6402,6403,6404,6405,6406,6449,6500,6501,6502,6503,6504,6505,6549,6550,6551,6552,6553,6599,6600,6601,6602,6603,6604,6605,6606,6607,6608,6611,6612,6613,6614,6615,6616,6617,      
6618,6649,6650,6651,6652,6653,6654,6655,6656,6657,6658,6699,6700,6701,6702,6703,6704,6705,6749,6750,6751,6752,6753,6754,6755,6756,6757,6758,6761,6799,6800,6801,6802,6803,6804,6805,      
6806,6849,6850,6851,6852,6853,6854,6855,6856,6899,6900,6901,6902,6903,6904,6905,6906,6907,6908,6911,6912,6913,6914,6915,6916,6917,6918,6921,6922,6923,6949,7000,7001,7002,7003,7004,      
7005,7006,7007,7008,7011,7012,7013,7014,7015,7016,7017,7049,7100,7101,7102,7103,7104,7149,7150,7151,7152,7153,7154,7155,7156,7157,7158,7161,7162,7163,7164,7165,7166,7167,7168,7199,      
7200,7201,7202,7203,7249,7250,7251,7252,7253,7254,7255,7256,7257,7258,7261,7262,7299,7300,7301,7302,7303,7304,7305,7349,7350,7351,7352,7353,7354,7355,7399,7400,7401,7402,7403,7404,      
7405,7406,7449,7500,7501,7549,7550,7551,7552,7599,7600,7601,7602,7603,7649,7650,7651,7652,7653,7654,7655,7699,7700,7701,7702,7749,7750,7751,7752,7753,7754,7755,7756,7757,7758,7761,      
7762,7763,7764,7765,7766,7799,7850,7851,7852,7853,7854,7899,7900,7901,7902,7949,7950,7951,7952,7953,7954,7999,8000,8001,8002,8003,8004,8005,8006,8007,8008,8011,8012,8049,8050,8051,      
8052,8053,8054,8055,8099,8100,8101,8102,8103,8104,8149,8150,8151,8152,8153,8154,8199,8300,8301,8302,8303,8304,8305,8306,8307,8308,8311,8312,8313,8314,8349,8350,8351,8352,8353,8354,      
8355,8356,8357,8358,8361,8362,8363,8364,8365,8399,8400,8401,8402,8403,8404,8449,8450,8451,8452,8453,8454,8499,8500,8501,8502,8503,8504,8549,8550,8551,8552,8553,8554,8555,8556,8557,8558,8599,'
      , F_NDKT || ',') > 0) THEN
      RETURN '0500';
    END IF;
    IF (INSTR ( '0134,0135,0136,0600,8750,8751,8752,8753,8754,8799,8800,8801,8802,8803,8804,8849,8950,8951,8952,8953,8999,9000,9001,9002,9003,9004,9049,9050,9051,9052,9053,9054,9055,9056,      
9057,9058,9061,9062,9063,9064,9065,9066,9099,9100,9101,9102,9103,9104,9105,9106,9107,9108,9111,9112,9113,9114,9115,9116,9117,9118,9121,9122,9123,9149,9200,9201,9202,9203,9204,9249,      
9250,9251,9252,9253,9254,9255,9299,9300,9301,9302,9303,9304,9305,9349,9350,9351,9352,9353,9354,9355,9399,9400,9401,9402,9403,9404,9449,', F_NDKT || ',') > 0) THEN
      RETURN '0600';
    END IF;
    IF (INSTR ( '0137,0138,0700,9500,9501,9502,9549,9650,9651,9652,9653,9699,9700,9701,9702,9703,9704,9749,', F_NDKT || ',') > 0) THEN
      RETURN '0700';
    END IF;
    RETURN NULL;
  END;
  FUNCTION FNC_GET_CONVERT_NDKT2TNHOM(
      F_NDKT NVARCHAR2)
    RETURN NVARCHAR2
  IS
  BEGIN
    IF (LENGTH (TRIM (F_NDKT)) = 0) THEN
      RETURN '';
    END IF;
    IF (INSTR ( '0050,0051,0052,0053,0054,0055,0056,0057,0058,0061,0062,0063,0064,0065,0099,', F_NDKT || ',') > 0) THEN
      RETURN 'AAAA';
    END IF;
    IF (INSTR ('0001,0002,0003,0004,0005,0006,0007,0008,0011,0012,0049,', F_NDKT || ',') > 0) THEN
      RETURN 'BBBB';
    END IF;
    IF (INSTR ( '0800,0801,0802,0803,0804,0805,0806,0807,0808,0811,0812,0813,0814,0817,0818,0819,0820,0821,0822,0823,0824,0825,0826,0827,0828,0831,0832,0833,0834,0835,0839,', F_NDKT || ',') > 0) THEN
      RETURN 'CCCC';
    END IF;
    IF (INSTR ( '0840,0841,0842,0843,0844,0859,0860,0861,0862,0863,0864,0879,0880,0881,0882,0883,0884,0899,', F_NDKT || ',') > 0) THEN
      RETURN 'DDDD';
    END IF;
    IF (INSTR ('0900,0901,0902,0903,0904,', F_NDKT || ',') > 0) THEN
      RETURN 'EEEE';
    END IF;
    IF (INSTR ('0121,0950,0951,0952,0953,0954,', F_NDKT || ',') > 0) THEN
      RETURN 'FFFF';
    END IF;
    IF (INSTR ('0400,0500,0600,0700,', F_NDKT || ',') > 0) THEN
      RETURN '0000';
    END IF;
    IF (INSTR ('3009,', F_NDKT || ',') > 0) THEN
      RETURN '0014';
    END IF;
    IF (INSTR ('1250,', F_NDKT || ',') > 0) THEN
      RETURN '0110';
    END IF;
    IF (INSTR ( '0111,1000,1001,1002,1003,1004,1005,1006,1007,1008,1011,1012,1013,1014,1049,1050,1051,1052,1053,1054,1055,1056,1057,1058,1099,1100,1101,1102,1103,1149,1150,1151,1152,1153,1199,1251,', F_NDKT || ',') > 0) THEN
      RETURN '0111';
    END IF;
    IF (INSTR ( '0112,1300,1301,1302,1349,1350,1351,1352,1353,1354,1399,1400,1401,1402,1403,1404,1405,1406,1449,1450,1451,1499,1500,1501,1502,1503,1549,1550,1551,1552,1553,1554,1555,1556,1557,1558,      
1561,1562,1563,1599,1600,', F_NDKT || ',') > 0) THEN
      RETURN '0112';
    END IF;
    IF (INSTR ( '0113,1601,1602,1603,1649,1700,1701,1702,1703,1704,1705,1749,1750,1751,1752,1753,1754,1755,1756,1757,1758,1761,1762,1763,1764,1765,1766,1767,1799,1800,1801,1802,1803,1804,1805,1806,      
1849,1850,1851,1852,1899,1900,1901,1902,1903,1949,1950,1951,1952,1953,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2019,2031,2032,2033,2034,2035,2036,2037,2038,2039,2041,2042,2043,      
2044,2045,2049,', F_NDKT || ',') > 0) THEN
      RETURN '0113';
    END IF;
    IF (INSTR (
      '0110,0114,0118,0122,2100,2101,2102,2103,2104,2105,2106,2107,2108,2111,2150,2151,2152,2153,2154,2155,2156,2157,2158,2161,2162,2163,2164,2165,2166,2167,2200,2201,2202,2203,2204,2205,      
2206,2207,2208,2211,2250,2251,2252,2253,2254,2255,2256,2257,2258,2261,2262,2263,2264,2265,2266,2267,2300,2301,2302,2303,2304,2305,2306,2307,2308,2311,2312,2313,2314,2315,2316,2317,2318,2321,      
2322,2323,2324,2350,2351,2352,2353,2354,2355,2356,2357,2358,2361,2362,2363,2364,2365,2366,2367,2368,2400,2401,2402,2403,2404,2405,2406,2407,2408,2411,2412,2413,2414,2415,2416,2417,2418,2421,      
2422,2450,2451,2452,2453,2454,2455,2456,2457,2458,2500,2501,2502,2503,2504,2505,2506,2507,2508,2511,2512,2513,2550,2551,2552,2553,2554,2555,2556,2557,2558,2561,2562,2563,2564,2565,2566,2567,      
2600,2601,2602,2603,2604,2605,2606,2607,2608,2611,2612,2613,2614,2615,2616,2617,2618,2621,2622,2623,2624,2625,2626,2627,2628,2631,2632,2633,2634,2635,2636,2637,2650,2651,2652,2653,2654,2655,      
2656,2657,2658,2661,2662,2663,2664,2665,2700,2701,2702,2703,2704,2705,2706,2707,2708,2711,2712,2713,2714,2715,2716,2717,2718,2721,2722,2750,2751,2752,2753,2754,2755,2756,2757,2758,2761,2762,      
2763,2764,2765,2766,2767,2768,2771,2772,2773,2774,2800,2801,2802,2803,2804,2805,2806,2807,2808,2811,2812,2813,2814,2815,2816,2817,2818,2821,2822,2823,2824,2825,2826,2827,2828,2831,2850,2851,      
2852,2853,2854,2855,2856,2857,2858,2861,2862,2863,2864,2865,2866,2867,2868,2871,2872,3000,3001,3002,3003,3004,3005,3006,3007,3008,3050,3051,3052,3053,3054,3055,3057,3058,3061,3062,3063,3064,      
3065,3066,3067,3068,3071,3072,3073,'
      , F_NDKT || ',') > 0) THEN
      RETURN '0114';
    END IF;
    IF (INSTR ( '0115,3200,3201,3202,3203,3204,3249,3250,3251,3252,3253,3254,3299,3300,3301,3302,3349,3350,3351,3352,3353,3354,3355,3356,3357,3358,3361,3362,3363,3364,3365,3399,3400,3401,3402,3403,      
3404,3405,3406,3449,3450,3451,3452,3453,3499,', F_NDKT || ',') > 0) THEN
      RETURN '0115';
    END IF;
    IF (INSTR ( '0116,3600,3601,3602,3603,3604,3605,3606,3607,3608,3649,3650,3651,3652,3653,3654,3699,3700,3701,3702,3703,3704,3705,3706,3749,3750,3751,3752,3753,3754,3755,3799,3800,3801,3802,3803,      
3849,3850,3851,3852,3853,3854,3899,3900,3901,3902,3903,3949,3950,3951,3952,3953,3954,3955,3999,', F_NDKT || ',') > 0) THEN
      RETURN '0116';
    END IF;
    IF (INSTR ( '0117,4050,4051,4052,4053,4054,4099,4100,4101,4102,4103,4104,4149,', F_NDKT || ',') > 0) THEN
      RETURN '0117';
    END IF;
    IF (INSTR ( '4250,4251,4252,4253,4254,4255,4256,4257,4258,4261,4262,4263,4264,4265,4266,4267,4268,4271,4272,4273,4274,4275,4299,4300,4301,4302,4303,4304,4305,4306,4307,4308,4311,4312,4313,4349,', F_NDKT || ',') > 0) THEN
      RETURN '0118';
    END IF;
    IF (INSTR ( '0120,4450,4451,4499,4500,4501,4502,4503,4504,4505,4506,4507,4549,', F_NDKT || ',') > 0) THEN
      RETURN '0120';
    END IF;
    IF (INSTR ( '4650,4651,4652,4653,4654,4655,4699,4700,4701,4702,4703,4749,4750,4751,4800,4801,4850,4851,', F_NDKT || ',') > 0) THEN
      RETURN '0121';
    END IF;
    IF (INSTR ( '0200,4900,4901,4902,4903,4904,4905,4906,4907,4908,4911,4912,4913,4914,4949,4917,4918,4927,4928,4931,4935,4936,4943,4944,4947,', F_NDKT || ',') > 0) THEN
      RETURN '0122';
    END IF;
    IF (INSTR ( '0123,0300,5050,5051,5052,5053,5054,5099,5100,5101,5102,5103,5104,5149,5150,5151,5152,5153,5154,5199,5200,5201,5202,5203,5204,5249,', F_NDKT || ',') > 0) THEN
      RETURN '0123';
    END IF;
    IF (INSTR ('0124,5350,5351,5352,5399,', F_NDKT || ',') > 0) THEN
      RETURN '0124';
    END IF;
    IF (INSTR ('0125,5450,5451,5452,5453,5499,', F_NDKT || ',') > 0) THEN
      RETURN '0125';
    END IF;
    IF (INSTR ('0126,5550,5551,5552,', F_NDKT || ',') > 0) THEN
      RETURN '0126';
    END IF;
    IF (INSTR ( '0129,6000,6001,6002,6003,6004,6049,6050,6051,6099,6100,6101,6102,6103,6104,6105,6106,6107,6108,6111,6112,6113,6114,6115,6116,6117,      
6118,6121,6122,6123,6124,6125,6149,6150,6151,6152,6153,6154,6155,6199,6200,6201,6202,6203,6249,6250,6251,6252,6253,6254,6255,6256,6257,6299,      
6300,6301,6302,6303,6304,6349,6350,6351,6352,6353,6399,6400,6401,6402,6403,6404,6405,6406,6449,', F_NDKT || ',') > 0) THEN
      RETURN '0129';
    END IF;
    IF (INSTR ( '0130,6500,6501,6502,6503,6504,6505,6549,6550,6551,6552,6553,6599,6600,6601,6602,6603,6604,6605,6606,6607,6608,6611,6612,6613,6614,      
6615,6616,6617,6618,6649,6650,6651,6652,6653,6654,6655,6656,6657,6658,6699,6700,6701,6702,6703,6704,6705,6749,6750,6751,6752,6753,6754,6755,      
6756,6757,6758,6761,6799,6800,6801,6802,6803,6804,6805,6806,6849,6850,6851,6852,6853,6854,6855,6856,6899,6900,6901,6902,6903,6904,6905,6906,      
6907,6908,6911,6912,6913,6914,6915,6916,6917,6918,6921,6922,6923,6949,7000,7001,7002,7003,7004,7005,7006,7007,7008,7011,7012,7013,7014,7015,7016,7017,7049,', F_NDKT || ',') > 0) THEN
      RETURN '0130';
    END IF;
    IF (INSTR ( '0131,7100,7101,7102,7103,7104,7149,7150,7151,7152,7153,7154,7155,7156,7157,7158,7161,7162,7163,7164,7165,7166,7167,7168,7199,7200,      
7201,7202,7203,7249,7250,7251,7252,7253,7254,7255,7256,7257,7258,7261,7262,7299,7300,7301,7302,7303,7304,7305,7349,7350,7351,7352,7353,7354,      
7355,7399,7400,7401,7402,7403,7404,7405,7406,7449,', F_NDKT || ',') > 0) THEN
      RETURN '0131';
    END IF;
    IF (INSTR ( '0132,7500,7501,7549,7550,7551,7552,7599,7600,7601,7602,7603,7649,7650,7651,7652,7653,7654,7655,7699,7700,7701,7702,7749,7750,7751,      
7752,7753,7754,7755,7756,7757,7758,7761,7762,7763,7764,7765,7766,7799,7850,7851,7852,7853,7854,7899,7900,7901,7902,7949,7950,7951,7952,7953,      
7954,7999,8000,8001,8002,8003,8004,8005,8006,8007,8008,8011,8012,8049,8050,8051,8052,8053,8054,8055,8099,8100,8101,8102,8103,8104,8149,8150,8151,8152,8153,8154,8199,,', F_NDKT || ',') > 0) THEN
      RETURN '0132';
    END IF;
    IF (INSTR ( '0133,8300,8301,8302,8303,8304,8305,8306,8307,8308,8311,8312,8313,8314,8349,8350,8351,8352,8353,8354,8355,8356,8357,8358,8361,8362,      
8363,8364,8365,8399,8400,8401,8402,8403,8404,8449,8450,8451,8452,8453,8454,8499,8500,8501,8502,8503,8504,8549,8550,8551,8552,8553,8554,8555,8556,8557,8558,8599,', F_NDKT || ',') > 0) THEN
      RETURN '0133';
    END IF;
    IF (INSTR ('0134,8750,8751,8752,8753,8754,8799,8800,8801,8802,8803,8804,8849,',F_NDKT || ',') > 0) THEN
      RETURN '0134';
    END IF;
    IF (INSTR ( '0135,8950,8951,8952,8953,8999,9000,9001,9002,9003,9004,9049,9050,9051,9052,9053,9054,9055,9056,9057,9058,9061,9062,9063,9064,9065,      
9066,9099,9100,9101,9102,9103,9104,9105,9106,9107,9108,9111,9112,9113,9114,9115,9116,9117,9118,9121,9122,9123,9149,', F_NDKT || ',') > 0) THEN
      RETURN '0135';
    END IF;
    IF (INSTR ( '0136,9200,9201,9202,9203,9204,9249,9250,9251,9252,9253,9254,9255,9299,9300,9301,9302,9303,9304,9305,9349,9350,9351,9352,9353,9354,      
9355,9399,9400,9401,9402,9403,9404,9449,', F_NDKT || ',') > 0) THEN
      RETURN '0136';
    END IF;
    IF (INSTR ('0137,9500,9501,9502,9549,', F_NDKT || ',') > 0) THEN
      RETURN '0137';
    END IF;
    IF (INSTR ( '0138,9650,9651,9652,9653,9699,9700,9701,9702,9703,9704,9749,', F_NDKT || ',') > 0) THEN
      RETURN '0138';
    END IF;
    RETURN NULL;
  END;
  FUNCTION FNC_GET_CONVERT_CHUONG2CAP(
      F_CHUONG NVARCHAR2)
    RETURN NVARCHAR2
  IS
    V_Return_Val NVARCHAR2 (1) := '4';
    V_Number NUMBER;
  BEGIN
    IF (LENGTH (TRIM (F_CHUONG)) = 0) THEN
      RETURN '';
    END IF;
    V_Number    := TO_NUMBER (F_CHUONG);
    IF (V_Number < 400) THEN
      RETURN '1';
    END IF;
    IF (V_Number < 600) THEN
      RETURN '2';
    END IF;
    IF (V_Number < 800) THEN
      RETURN '3';
    END IF;
    RETURN V_Return_Val;
  END;
  FUNCTION FNC_GET_CONVERT_NKT2LOAI(
      F_NKT NVARCHAR2)
    RETURN NVARCHAR2
  IS
    V_Return_Val NVARCHAR2 (10) := '4';
    V_Sub NVARCHAR2 (2)         := SUBSTR (F_NKT, 1, 2);
  BEGIN
    CASE
    WHEN V_Sub IN ('01', '02') THEN
      V_Return_Val := '010';
    WHEN V_Sub IN ('04', '05', '06') THEN
      V_Return_Val := '040';
    WHEN V_Sub IN ('07', '08', '09', '10', '11', '12') THEN
      V_Return_Val := '070';
    WHEN V_Sub IN ('13', '14', '15') THEN
      V_Return_Val := '130';
    WHEN V_Sub IN ('16', '17', '18') THEN
      V_Return_Val := '160';
    WHEN V_Sub IN ('19', '20', '21') THEN
      V_Return_Val := '190';
    WHEN V_Sub IN ('22', '23', '24') THEN
      V_Return_Val := '220';
    WHEN V_Sub IN ('25', '26', '27') THEN
      V_Return_Val := '250';
    WHEN V_Sub IN ('28', '29', '30') THEN
      V_Return_Val := '280';
    WHEN V_Sub IN ('31', '32', '33') THEN
      V_Return_Val := '310';
    WHEN V_Sub IN ('34', '35', '36') THEN
      V_Return_Val := '340';
    WHEN V_Sub IN ('37', '38', '39') THEN
      V_Return_Val := '370';
    WHEN V_Sub IN ('40', '41', '42') THEN
      V_Return_Val := '400';
    WHEN V_Sub IN ('43', '44', '45') THEN
      V_Return_Val := '430';
    WHEN V_Sub IN ('46', '47', '48') THEN
      V_Return_Val := '460';
    WHEN V_Sub IN ('49', '50', '51') THEN
      V_Return_Val := '490';
    WHEN V_Sub IN ('52', '53', '54') THEN
      V_Return_Val := '520';
    WHEN V_Sub IN ('55', '56', '57') THEN
      V_Return_Val := '550';
    WHEN V_Sub IN ('58', '59', '60') THEN
      V_Return_Val := '580';
    WHEN V_Sub IN ('61', '62', '63') THEN
      V_Return_Val := '610';
    WHEN V_Sub IN ('64', '65', '66') THEN
      V_Return_Val := '640';
    ELSE
      V_Return_Val := '000';
    END CASE;
    RETURN V_Return_Val;
  END;
  FUNCTION FNC_GET_CONVERT_NDKT2MUC(
      F_NDKT NVARCHAR2)
    RETURN NVARCHAR2
  IS
    V_Right NVARCHAR2 (2) := SUBSTR (F_NDKT, -2, 2);
    V_Mid NVARCHAR2 (2)   := SUBSTR (F_NDKT, 3, 1);
    V_Return_Val NVARCHAR2 (2);
    V_Number NUMBER;
  BEGIN
    IF V_Right       <> '00' THEN
      V_Number       := TO_NUMBER (V_Mid);
      IF (V_Number    < 5) THEN
        V_Return_Val := '00';
      ELSIF (V_Number < 10) THEN
        V_Return_Val := '50';
      ELSE
        V_Return_Val := 'NA';
      END IF;
    ELSE
      V_Return_Val := SUBSTR (F_NDKT, -2, 2);
    END IF;
    RETURN SUBSTR (F_NDKT, 1, 2) || V_Return_Val;
  END;
  FUNCTION FNC_GET_LOAI_NS(
      F_MUC NVARCHAR2)
    RETURN NVARCHAR2
  IS
    V_LEFT NVARCHAR2 (2);
    V_Return_Val NVARCHAR2 (10);
  BEGIN
    IF LENGTH (F_MUC) > 2 THEN
      V_LEFT         := SUBSTR (F_MUC, 0, 2);
    END IF;
    IF (V_LEFT     <> '00') THEN
      V_Return_Val := 'TRONG_NS';
    ELSE
      V_Return_Val := 'TAMCHI_NS';
    END IF;
    RETURN V_Return_Val;
  END;
  FUNCTION FNC_CONVERT_FORMULA(
      F_FORMULA NVARCHAR2)
    RETURN NVARCHAR2
  IS
    V_WHERE NVARCHAR2 (15000);
  BEGIN
    --DBMS_OUTPUT.put_line ('CT:' || F_FORMULA);
    IF LENGTH(NVL(F_FORMULA,'')) = 0 THEN
      V_WHERE                   := ' 1=1 ';
    ELSE
      V_WHERE := '';
      V_WHERE := REPLACE (F_FORMULA, 'CA', ' MA_CAP like ');
      V_WHERE := REPLACE (V_WHERE, 'CH', ' MA_CHUONG like ');
      V_WHERE := REPLACE (V_WHERE, 'L', ' MA_LOAI like ');
      V_WHERE := REPLACE (V_WHERE, 'KH', ' MA_NGANHKT like ');
      V_WHERE := REPLACE (V_WHERE, 'MC', ' MA_MUC like ');
      V_WHERE := REPLACE (V_WHERE, 'TM', ' MA_TIEUMUC like ');
      V_WHERE := REPLACE (V_WHERE, 'NS', ' MA_CAPNS like ');
      V_WHERE := REPLACE (V_WHERE, 'TK', ' MA_TKTN like ');
      V_WHERE := REPLACE (V_WHERE, 'NV', ' MA_NGUON_NSNN like ');
      V_WHERE := REPLACE (V_WHERE, 'DV', ' MA_DVQHNS like ');
      V_WHERE := REPLACE (V_WHERE, 'CT', ' MA_CTMTQG like ');
      V_WHERE := REPLACE (V_WHERE, 'DB', ' MA_DIABAN like ');
      V_WHERE := REPLACE (V_WHERE, 'KB', ' MA_KBNN like ');
      V_WHERE := REPLACE (V_WHERE, ',', ' OR ');
      V_WHERE := REPLACE (V_WHERE, '+', ' AND ');
      V_WHERE := REPLACE (V_WHERE, '-', ' AND NOT ');
      V_WHERE := REPLACE (V_WHERE, '[', ' BETWEEN ''');
      V_WHERE := REPLACE (V_WHERE, '~', ''' AND ''');
      V_WHERE := REPLACE (V_WHERE, ']', '''');
      V_WHERE := REPLACE (V_WHERE, 'like  BETWEEN', ' BETWEEN ');
    END IF;
    --DBMS_OUTPUT.ENABLE(500000);
    --DBMS_OUTPUT.put_line (V_WHERE);
    RETURN V_WHERE;
    -- Insert into TB_LOG(M) Values (V_WHERE);
    --Return '1=1';
  END;
  FUNCTION FNC_CONVERT_FORMULA_FROM_TAB(
      F_FORMULA VARCHAR2)
    RETURN VARCHAR2
  IS
    V_WHERE VARCHAR2 (20000);
  BEGIN
    IF F_FORMULA           IS NULL THEN
      V_WHERE              := ' 1=1 ';
    ELSIF (TRIM (F_FORMULA) = '') THEN
      V_WHERE              := '1=1';
    ELSE
      V_WHERE := REPLACE (F_FORMULA, 'CA', ' SEGMENT4 like ');
      V_WHERE := REPLACE (V_WHERE, 'KH', ' SEGMENT8 like ');
      V_WHERE := REPLACE (V_WHERE, 'L', ' SEGMENT3 like ');
      V_WHERE := REPLACE (V_WHERE, 'TM', ' SEGMENT3 like ');
      V_WHERE := REPLACE (V_WHERE, 'TK', ' SEGMENT2 like ');
      V_WHERE := REPLACE (V_WHERE, 'NV', ' SEGMENT11 like ');
      V_WHERE := REPLACE (V_WHERE, 'DV', ' SEGMENT5 like ');
      V_WHERE := REPLACE (V_WHERE, 'CT', ' SEGMENT9 like ');
      V_WHERE := REPLACE (V_WHERE, 'DB', ' SEGMENT6 like ');
      V_WHERE := REPLACE (V_WHERE, ',', ' OR ');
      V_WHERE := REPLACE (V_WHERE, '+', ' AND ');
      V_WHERE := REPLACE (V_WHERE, '-', ' AND NOT ');
      V_WHERE := REPLACE (V_WHERE, '[', ' BETWEEN ''');
      V_WHERE := REPLACE (V_WHERE, '~', ''' AND ''');
      V_WHERE := REPLACE (V_WHERE, ']', '''');
      V_WHERE := REPLACE (V_WHERE, 'like  BETWEEN', ' BETWEEN ');
    END IF;
    RETURN NVL (V_WHERE, '');
  END;
  FUNCTION FNC_GET_TEN_CHITIEU(
      p_Ma_CHITIEU IN VARCHAR2,
      p_NGAY_HL    IN DATE)
    RETURN VARCHAR2
  IS
    v_return VARCHAR2 (20000);
  BEGIN
    SELECT A.TEN_CHITIEU
    INTO v_return
    FROM DM_CHITIEU A
    WHERE A.TRANG_THAI = 'A'
    AND A.MA_CHITIEU   = p_Ma_CHITIEU
    AND A.NGAY_HL      =
      (SELECT MAX (NGAY_HL)
      FROM DM_CHITIEU SQ
      WHERE SQ.MA_CHITIEU = A.MA_CHITIEU
      AND SQ.NGAY_HL     <= p_NGAY_HL
      );
    IF v_return IS NOT NULL THEN
      RETURN v_return;
    ELSE
      RETURN '';
    END IF;
  END;
  FUNCTION FNC_GET_CONGTHUC_CHITIEU(
      p_Ma_CHITIEU IN VARCHAR2,
      p_NGAY_HL    IN DATE)
    RETURN VARCHAR2
  IS
    v_return VARCHAR2 (5000);
  BEGIN
    SELECT A.CONGTHUC
    INTO v_return
    FROM DM_CHITIEU A
    WHERE A.TRANG_THAI = 'A'
    AND A.MA_CHITIEU   = p_Ma_CHITIEU
    AND A.NGAY_HL      =
      (SELECT MAX (NGAY_HL)
      FROM DM_CHITIEU SQ
      WHERE SQ.MA_CHITIEU = A.MA_CHITIEU
      AND SQ.NGAY_HL     <= p_NGAY_HL
      );
    IF v_return IS NOT NULL THEN
      RETURN v_return;
    ELSE
      RETURN '';
    END IF;
  END;
  PROCEDURE PRC_TH_MLNS(
      P_BNGAY_HACHTOAN DATE,
      P_ENGAY_HACHTOAN DATE,
      P_LOAI           NUMBER)
  IS
  BEGIN
 
    IF (P_LOAI = 1) THEN
      INSERT INTO TEMP_MLNS
      SELECT MA_NGHIEPVU,
        MA_TKTN,
        TEN_TKTN,
        MA_DVQHNS,
        TEN_DVQHNS,
        MA_DIABAN,
        TEN_DIABAN,
        MA_CAP,
        TEN_CAP,
        MA_CAPMLNS,
        TEN_CAPMLNS,
        MA_CHUONG,
        TEN_CHUONG,
        MA_NGANHKT,
        TEN_NGANHKT,
        MA_LOAI,
        TEN_LOAI,
        MA_TIEUMUC,
        TEN_TIEUMUC,
        MA_MUC,
        TEN_MUC,
        MA_TIEUNHOM,
        TEN_TIEUNHOM,
        MA_NHOM,
        TEN_NHOM,
        MA_CTMTQG,
        TEN_CTMTQG,
        MA_KBNN,
        TEN_KBNN,
        MA_NGUON_NSNN,
        TEN_NGUON_NSNN,
        NGAY_KET_SO,
        NGAY_HIEU_LUC,
        SUM (GIA_TRI_HACH_TOAN),
        ATTRIBUTE8
      FROM PHA_HACHTOAN_CHI VC
      WHERE VC.NGAY_HIEU_LUC BETWEEN P_BNGAY_HACHTOAN AND P_ENGAY_HACHTOAN
      and VC.NGAY_KET_SO <= to_date('31122016','ddMMyyyy')
      GROUP BY MA_NGHIEPVU,
        MA_TKTN,
        TEN_TKTN,
        MA_DVQHNS,
        TEN_DVQHNS,
        MA_DIABAN,
        TEN_DIABAN,
        MA_CAP,
        TEN_CAP,
        MA_CAPMLNS,
        TEN_CAPMLNS,
        MA_CHUONG,
        TEN_CHUONG,
        MA_NGANHKT,
        TEN_NGANHKT,
        MA_LOAI,
        TEN_LOAI,
        MA_TIEUMUC,
        TEN_TIEUMUC,
        MA_MUC,
        TEN_MUC,
        MA_TIEUNHOM,
        TEN_TIEUNHOM,
        MA_NHOM,
        TEN_NHOM,
        MA_CTMTQG,
        TEN_CTMTQG,
        MA_KBNN,
        TEN_KBNN,
        MA_NGUON_NSNN,
        TEN_NGUON_NSNN,
        NGAY_KET_SO,
        NGAY_HIEU_LUC,
        ATTRIBUTE8;
    ELSE
      INSERT INTO TEMP_MLNS
      SELECT MA_NGHIEPVU,
        MA_TKTN,
        TEN_TKTN,
        MA_DVQHNS,
        TEN_DVQHNS,
        MA_DIABAN,
        TEN_DIABAN,
        MA_CAP,
        TEN_CAP,
        MA_CAP,
        TEN_CAP,
        --MA_CAPMLNS,
        --TEN_CAPMLNS,
        MA_CHUONG,
        TEN_CHUONG,
        MA_NGANHKT,
        TEN_NGANHKT,
        MA_LOAI,
        TEN_LOAI,
        MA_TIEUMUC,
        TEN_TIEUMUC,
        MA_MUC,
        TEN_MUC,
        MA_TIEUNHOM,
        TEN_TIEUNHOM,
        MA_NHOM,
        TEN_NHOM,
        MA_CTMTQG,
        TEN_CTMTQG,
        MA_KBNN,
        TEN_KBNN,
        MA_NGUON_NSNN,
        TEN_NGUON_NSNN,
        NGAY_KET_SO,
        NGAY_HIEU_LUC,
        SUM (GIA_TRI_HACH_TOAN),
        ATTRIBUTE8
      FROM PHA_HACHTOAN_THU VT
      WHERE VT.NGAY_HIEU_LUC BETWEEN P_BNGAY_HACHTOAN AND P_ENGAY_HACHTOAN
      GROUP BY MA_NGHIEPVU,
        MA_TKTN,
        TEN_TKTN,
        MA_DVQHNS,
        TEN_DVQHNS,
        MA_DIABAN,
        TEN_DIABAN,
        MA_CAPMLNS,
        TEN_CAPMLNS,
        MA_CAP,
        TEN_CAP,
        MA_CHUONG,
        TEN_CHUONG,
        MA_NGANHKT,
        TEN_NGANHKT,
        MA_LOAI,
        TEN_LOAI,
        MA_TIEUMUC,
        TEN_TIEUMUC,
        MA_MUC,
        TEN_MUC,
        MA_TIEUNHOM,
        TEN_TIEUNHOM,
        MA_NHOM,
        TEN_NHOM,
        MA_CTMTQG,
        TEN_CTMTQG,
        MA_KBNN,
        TEN_KBNN,
        MA_NGUON_NSNN,
        TEN_NGUON_NSNN,
        NGAY_KET_SO,
        NGAY_HIEU_LUC,
        ATTRIBUTE8;
    END IF;
  END;
  PROCEDURE PRC_SUM_UP
  IS
    V_LV  NUMBER := 0;
    V_MAX NUMBER := 0;
    V_MD TEMPTB_DMCT%ROWTYPE;
  TYPE RC_MD
IS
  REF
  CURSOR;
    C_MD RC_MD;
  BEGIN
    SELECT MAX (LENGTH (tmp.MA_DONG)) INTO V_MAX FROM temptb_dmct tmp;
  WHILE (V_MAX > 0)
  LOOP
    OPEN C_MD FOR ('Select * From Temptb_dmct Tmp                        
Where Length(Tmp.MA_DONG) = :V_MAX') USING V_MAX;
    LOOP
      FETCH C_MD INTO V_MD;
      EXIT
    WHEN C_MD%NOTFOUND;
      IF(V_MD.DAU = 1) THEN
        UPDATE temptb_dmct tmp
          --
          --                Set tmp.TW_LK = select sum(TW_LK) from  tmp where tmp.MA_DONG like
        SET tmp.TW_LK     = NVL (tmp.TW_LK, 0)             + NVL (V_MD.TW_LK, 0),
          tmp.TINH_LK     = NVL (tmp.TINH_LK, 0)           + NVL (V_MD.TINH_LK, 0),
          tmp.HUYEN_LK    = NVL (tmp.HUYEN_LK, 0)          + NVL (V_MD.HUYEN_LK, 0),
          tmp.XA_LK       = NVL (tmp.XA_LK, 0)             + NVL (V_MD.XA_LK, 0),
          tmp.TW_PS       = NVL (tmp.TW_PS, 0)             + NVL (V_MD.TW_PS, 0),
          tmp.TINH_PS     = NVL (tmp.TINH_PS, 0)           + NVL (V_MD.TINH_PS, 0),
          tmp.HUYEN_PS    = NVL (tmp.HUYEN_PS, 0)          + NVL (V_MD.HUYEN_PS, 0),
          tmp.XA_PS       = NVL (tmp.XA_PS, 0)             + NVL (V_MD.XA_PS, 0)
        WHERE tmp.MA_DONG = SUBSTR (V_MD.MA_DONG, 0, V_MAX - 2);
      ElsIF (V_MD.DAU     =                                -1) THEN
        UPDATE temptb_dmct tmp
        SET tmp.TW_LK     = NVL (tmp.TW_LK, 0)             - NVL (V_MD.TW_LK, 0),
          tmp.TINH_LK     = NVL (tmp.TINH_LK, 0)           - NVL (V_MD.TINH_LK, 0),
          tmp.HUYEN_LK    = NVL (tmp.HUYEN_LK, 0)          - NVL (V_MD.HUYEN_LK, 0),
          tmp.XA_LK       = NVL (tmp.XA_LK, 0)             - NVL (V_MD.XA_LK, 0),
          tmp.TW_PS       = NVL (tmp.TW_PS, 0)             - NVL (V_MD.TW_PS, 0),
          tmp.TINH_PS     = NVL (tmp.TINH_PS, 0)           - NVL (V_MD.TINH_PS, 0),
          tmp.HUYEN_PS    = NVL (tmp.HUYEN_PS, 0)          - NVL (V_MD.HUYEN_PS, 0),
          tmp.XA_PS       = NVL (tmp.XA_PS, 0)             - NVL (V_MD.XA_PS, 0)
        WHERE tmp.MA_DONG = SUBSTR (V_MD.MA_DONG, 0, V_MAX - 2);
      END IF;
    END LOOP;
    V_MAX := V_MAX - 2;
  END LOOP;
/*Update temptb_dmct tmp
Set tmp.ILV =
(Select Sub.LV
From (
Select tmp1.MA_CHITIEU as MA_CHITIEU, tmp1.MA_CHITIEU_CHA as MA_CHITIEU_CHA, level as LV
from temptb_dmct tmp1
Start with tmp1.MA_CHITIEU_CHA is null
Connect by prior tmp1.MA_CHITIEU = tmp1.MA_CHITIEU_CHA) Sub
Where tmp.MA_CHITIEU = Sub.MA_CHITIEU_CHA);
Select max(tmp.ILV) Into V_LV From temptb_dmct tmp;
While V_LV > 1 loop
Update temptb_dmct tmp
Set tmp.TW_LK =
(Select v.TW_LK
From (Select tmp1.MA_CHITIEU_CHA,
nvl(sum(tmp1.TW_LK), 0) TW_LK
From temptb_dmct tmp1
Where tmp1.ILV = V_LV
Group by tmp1.MA_CHITIEU_CHA) v
Where tmp.MA_CHITIEU = v.MA_CHITIEU_CHA)
Where tmp.TW_LK is null;
Update temptb_dmct tmp
Set tmp.TINH_LK =
(Select v.TINH_LK
From (Select tmp1.MA_CHITIEU_CHA,
nvl(sum(tmp1.TINH_LK), 0) TINH_LK
From temptb_dmct tmp1
Where tmp1.ILV = V_LV
Group by tmp1.MA_CHITIEU_CHA) v
Where tmp.MA_CHITIEU = v.MA_CHITIEU_CHA)
Where tmp.TINH_LK is null;
Update temptb_dmct tmp
Set tmp.HUYEN_LK =
(Select v.HUYEN_LK
From (Select tmp1.MA_CHITIEU_CHA,
nvl(sum(tmp1.HUYEN_LK), 0) HUYEN_LK
From temptb_dmct tmp1
Where tmp1.ILV = V_LV
Group by tmp1.MA_CHITIEU_CHA) v
Where tmp.MA_CHITIEU = v.MA_CHITIEU_CHA)
Where tmp.HUYEN_LK is null;
Update temptb_dmct tmp
Set tmp.XA_LK =
(Select v.XA_LK
From (Select tmp1.MA_CHITIEU_CHA,
nvl(sum(tmp1.XA_LK), 0) XA_LK
From temptb_dmct tmp1
Where tmp1.ILV = V_LV
Group by tmp1.MA_CHITIEU_CHA) v
Where tmp.MA_CHITIEU = v.MA_CHITIEU_CHA)
Where tmp.XA_LK is null;
V_LV := V_LV - 1;
end loop;*/
END;
-- F_LOAIDATA : 0 Thu, 1 Chi
PROCEDURE PRC_GET_DATA(
    F_LOAIDATA NUMBER,
    F_TABLE_NAME NCHAR,
    F_TUNGAY  DATE,
    F_DENNGAY DATE,
    F_SHKB NCHAR)
IS
  CURSOR c_nv
  IS
    SELECT *
    FROM DM_NGHIEPVU nv
    WHERE 1            =1
    AND Lower(nv.LOAI) = (
      CASE F_LoaiData
        WHEN 0
        THEN 'thu'
        WHEN 1
        THEN 'chi'
        WHEN 2
        THEN 'dutoan'
        ELSE 'null'
      END) ;
  --r_nv          DM_NGHIEPVU%ROWTYPE;
  V_SQL    VARCHAR2(32000);
  V_INSERT VARCHAR2(32000);
  V_Del    VARCHAR2(500) := 'Delete '|| F_TABLE_NAME ||' where 1=1 And NGAY_KET_SO >= To_Date(' || Chr(39) || TO_CHAR(F_TUNGAY,'dd/MM/yyyy') || Chr(39) || ',' || Chr(39) || 'dd/MM/yyyy' || Chr(39) || ')' || ' And NGAY_KET_SO <= To_Date(' || Chr(39) || TO_CHAR(F_DENNGAY,'dd/MM/yyyy') || Chr(39) || ',' || Chr(39) || 'dd/MM/yyyy' || Chr(39) || ')' ;
BEGIN
  V_SQL := 'Insert Into '|| F_TABLE_NAME ||
  '                                     
(  SEGMENT1,                                       
MA_TKTN,                                       
MA_NHOM,                                       
MA_TIEUNHOM,                                       
MA_MUC,                                       
MA_TIEUMUC,                                       
MA_CAP,                                       
MA_DVQHNS,                                       
MA_DIABAN,                                       
MA_CAPMLNS,                                       
MA_CHUONG,                                       
MA_NGANHKT,                                       
MA_LOAI,                                       
MA_CTMTQG,                                       
MA_KBNN,                                       
MA_NGUON_NSNN,                                       
SEGMENT12,                                       
SET_OF_BOOKS_ID,                                       
SOB_NAME,                                       
PERIOD_NAME,                                       
NGAY_KET_SO,                                       
NGAY_HIEU_LUC,                                       
ENTERED_DR,                                       
ENTERED_CR,                                          
ACTUAL_FLAG,                                       
CURRENCY_CODE,                                        
TRANSFORM_DATE,                                       
VOUCHER_DATE,                                       
ATTRIBUTE8,                                                                                                         
MA_NGHIEPVU,                                                                          
GIA_TRI_HACH_TOAN,                                       
TEN_TKTN,                                       
TEN_NHOM,                                       
TEN_TIEUNHOM,                                       
TEN_MUC,                                       
TEN_TIEUMUC,                                       
TEN_CAP,                                       
TEN_CHUONG,                                       
TEN_CAPMLNS,                                       
TEN_CTMTQG,                                       
TEN_KBNN,                                       
TEN_NGUON_NSNN )                         
Select  SEGMENT1,                                 
SEGMENT2 AS MA_TKTN,                                
STC_PA_SYS.FNC_GET_CONVERT_NDKT2NHOM(SEGMENT3) AS MA_NHOM,                                
STC_PA_SYS.FNC_GET_CONVERT_NDKT2TNHOM(SEGMENT3) AS MA_TIEUNHOM,                                
STC_PA_SYS.FNC_GET_CONVERT_NDKT2MUC(SEGMENT3) AS MA_MUC ,                                
SEGMENT3 AS MA_TIEUMUC,                                
SEGMENT4 AS MA_CAP,                                
SEGMENT5 AS MA_DVQHNS,                                
SEGMENT6 AS MA_DIABAN,                                
STC_PA_SYS.FNC_GET_CONVERT_CHUONG2CAP(SEGMENT7) AS MA_CAPMLNS,                                
SEGMENT7 AS MA_CHUONG,                                                            

SEGMENT8 AS MA_NGANHKT,                                
STC_PA_SYS.FNC_GET_CONVERT_NKT2LOAI(SEGMENT8) AS MA_LOAI,                                                            

SEGMENT9 AS MA_CTMTQG,                                                            

SEGMENT10 AS MA_KBNN,                                                            

SEGMENT11 AS MA_NGUON_NSNN,                                

SEGMENT12,                                
SET_OF_BOOKS_ID,                                
SOB_NAME,                                
PERIOD_NAME,                                
POSTED_DATE AS NGAY_KET_SO,                                
EFFECTIVE_DATE AS NGAY_HIEU_LUC,                                
ENTERED_DR,                                
ENTERED_CR,                                
--ACCOUNTED_DR,                                
--ACCOUNTED_CR,                                
ACTUAL_FLAG,                                
CURRENCY_CODE,                                
TRANSFORM_DATE,                                
VOUCHER_DATE,                                
ATTRIBUTE8,                                 
LOAI_NV AS LOAI_NGHIEP_VU,                                 
DR_CR  AS TIEN_HACH_TOAN,                                
STC_PA_SYS.FNC_GET_TEN_DM ('
  || Chr(39) || 'DM_TKTN' || Chr(39) || ',' || Chr(39) || 'TEN_TKTN' || Chr(39) || ',' || Chr(39) || 'MA_TKTN' || Chr(39) || ',' || ' SEGMENT2,                                     
EFFECTIVE_DATE) AS TEN_TKTN,                                
STC_PA_SYS.FNC_GET_DICTIONARY(' || Chr(39) || 'MA_NHOM' || Chr(39) || ',STC_PA_SYS.FNC_GET_CONVERT_NDKT2NHOM(SEGMENT3),EFFECTIVE_DATE) AS TEN_NHOM,                                
STC_PA_SYS.FNC_GET_TEN_DM (' || Chr(39) || 'PHA_DM_TIEUNHOM' || Chr(39) || ',' || Chr(39) || 'TEN_TIEUNHOM' || Chr(39) || ',' || Chr(39) || 'MA_TIEUNHOM' || Chr(39) || ',' || ' STC_PA_SYS.FNC_GET_CONVERT_NDKT2TNHOM (SEGMENT3),                                     
EFFECTIVE_DATE) AS TEN_TIEUNHOM,                                     
STC_PA_SYS.FNC_GET_TEN_DM (' || Chr(39) || 'DM_MUC' || Chr(39) || ',' || Chr(39) || 'TEN_MUC' || Chr(39) || ',' || Chr(39) || 'MA_MUC' || Chr(39) || ',' ||
  ' STC_PA_SYS.FNC_GET_CONVERT_NDKT2MUC (SEGMENT3),                                     
POSTED_DATE)                                     
AS TEN_MUC,                                     
STC_PA_SYS.FNC_GET_TEN_DM (' || Chr(39) || 'DM_TIEUMUC' || Chr(39) || ',' || Chr(39) || 'TEN_TIEUMUC' || Chr(39) || ',' || Chr(39) || 'MA_TIEUMUC' || Chr(39) || ',' || ' SEGMENT3,                                                             
EFFECTIVE_DATE)                                     
AS TEN_TIEUMUC,                                     
STC_PA_SYS.FNC_GET_DICTIONARY (' || Chr(39) || 'MA_CAP' || Chr(39) || ',' || ' STC_PA_SYS.FNC_GET_CONVERT_CHUONG2CAP (SEGMENT7),                                     
EFFECTIVE_DATE)                                     
AS TEN_CAP,                                     
STC_PA_SYS.FNC_GET_TEN_DM (' || Chr(39) || 'DM_CHUONG'|| Chr(39) || ',' || Chr(39) || 'TEN_CHUONG'|| Chr(39) || ',' || Chr(39) || 'MA_CHUONG'|| Chr(39) || ',' ||
  ' SEGMENT7,                                                             
EFFECTIVE_DATE)                                     
AS TEN_CHUONG,                                     
STC_PA_SYS.FNC_GET_DICTIONARY (' || Chr(39) || 'MA_CAP'|| Chr(39) || ',' || ' STC_PA_SYS.FNC_GET_CONVERT_CHUONG2CAP (SEGMENT7),                                     
EFFECTIVE_DATE)                                     
AS TEN_CAPNS,                                     
STC_PA_SYS.FNC_GET_TEN_DM (' || Chr(39) || 'DM_CTMTQG'|| Chr(39) || ',' || Chr(39) || 'TEN_CTMTQG'|| Chr(39) || ',' || Chr(39) || 'MA_CTMTQG'|| Chr(39) || ',' || ' SEGMENT9,                                                             
EFFECTIVE_DATE)                                     
AS TEN_CTMTQG,                                     
STC_PA_SYS.FNC_GET_TEN_DM  (' || Chr(39) || 'DM_KBNN'|| Chr(39) || ',' || Chr(39) || 'TEN_KBNN' || Chr(39) || ',' || Chr(39) || 'MA_KBNN' || Chr(39) || ',' ||
  ' SEGMENT10,                                                             
EFFECTIVE_DATE)                                     
AS TEN_KBNN,                                     
STC_PA_SYS.FNC_GET_TEN_DM (' || Chr(39) || 'DM_NGUON_NSNN'|| Chr(39) || ',' || Chr(39) || 'TEN_NGUON_NSNN'|| Chr(39) || ',' || Chr(39) || 'MA_NGUON_NSNN'|| Chr(39) || ',' || ' SEGMENT11,                                                             
EFFECTIVE_DATE)                                     
AS TEN_NGUON_NSNN                                
From TABWH_JEL_FCT                                 
Where 1=1                                 
AND POSTED_DATE >= To_Date(' || Chr(39) || TO_CHAR(F_TUNGAY,'dd/MM/yyyy') || Chr(39) || ',' || Chr(39) || 'dd/MM/yyyy' || Chr(39) || ')' || ' And POSTED_DATE <= To_Date(' || Chr(39) || TO_CHAR(F_DENNGAY,'dd/MM/yyyy') || Chr(39) || ',' || Chr(39) || 'dd/MM/yyyy' || Chr(39) || ')';
  -- Neu nhan theo tung so hieu kho bac rieng
  IF(F_SHKB IS NOT NULL OR LENGTH(Trim(F_SHKB)) > 0) THEN
    V_Del   := V_Del || ' And Segment_10 = ' || Chr(39) || F_SHKB || Chr(39);
  END IF;
  CASE F_LOAIDATA
  WHEN 0 THEN -- Thu
    -- Delete data
    V_Del := REPLACE(V_Del,'PHA_HACHTOAN_CHI','PHA_HACHTOAN_THU');
    --DBMS_OUTPUT.PUT_LINE(V_Del);
    --Execute Immediate V_Del;
    --Lay Du lieu
    V_SQL := REPLACE(V_SQL,'PHA_HACHTOAN_CHI','PHA_HACHTOAN_THU');
    -- Lay du lieu theo nghiep vu
    FOR r_nv IN c_nv
    LOOP
      V_INSERT := ' ';
      V_INSERT := V_SQL;
      -- Lay nghiep vu
      V_INSERT := REPLACE(V_INSERT, 'LOAI_NV', Chr(39) || r_nv.ma_nghiepvu || Chr(39));
      -- Chuyen doi dieu kien so tien lay Dr - Cr hoac Cr - Dr ... tu bang DM_NghiepVu
      V_INSERT := REPLACE(V_INSERT, 'DR_CR', r_nv.DR_CR);
      -- Chuyen doi dieu kien tu cong thuc lay trong bang DM_NghiepVu
      V_INSERT := V_INSERT || ' And (' || FNC_CONVERT_FORMULA_FROM_TAB(r_nv.CONG_THUC) || ')';
      -- Lay them dieu kien tu bang DM_NghiepVu
      V_INSERT := V_INSERT || ' And ' || r_nv.Dieu_Kien;
      -- Thuc thi cau lenh
      --DBMS_OUTPUT.PUT_LINE(V_INSERT);
      EXECUTE Immediate V_INSERT;
    END LOOP;
  WHEN 1 THEN -- Chi
    -- Delete data
    --DBMS_OUTPUT.PUT_LINE(V_Del);
    EXECUTE Immediate V_Del;
    -- Lay du lieu theo nghiep vu
    FOR r_nv IN c_nv
    LOOP
      V_INSERT := ' ';
      V_INSERT := V_SQL;
      -- Lay nghiep vu
      V_INSERT := REPLACE(V_INSERT, 'LOAI_NV', Chr(39) || r_nv.ma_nghiepvu || Chr(39));
      -- Chuyen doi dieu kien so tien lay Dr - Cr hoac Cr - Dr ... tu bang DM_NghiepVu
      V_INSERT := REPLACE(V_INSERT, 'DR_CR', r_nv.DR_CR);
      -- Chuyen doi dieu kien tu cong thuc lay trong bang DM_NghiepVu
      V_INSERT := V_INSERT || ' And (' || FNC_CONVERT_FORMULA_FROM_TAB(r_nv.CONG_THUC) || ')';
      V_INSERT :=REPLACE (V_INSERT, 'SEGMENT3 like ''340''', ' SEGMENT3 like ''34''');
      -- Lay them dieu kien tu bang DM_NghiepVu
      V_INSERT := V_INSERT || ' And ' || r_nv.Dieu_Kien;
      -- Thuc thi cau lenh
      --DBMS_OUTPUT.PUT_LINE(V_INSERT);
      EXECUTE Immediate V_INSERT;
    END LOOP;
  WHEN 2 THEN -- Du toan
    -- Delete data
    V_Del := REPLACE(V_Del,'PHA_HACHTOAN_CHI','PHA_DUTOAN');
    --DBMS_OUTPUT.PUT_LINE(V_Del);
    --Execute Immediate V_Del;
    --Lay Du lieu
    V_SQL := REPLACE(V_SQL,'PHA_HACHTOAN_CHI','PHA_DUTOAN');
    -- Lay du lieu theo nghiep vu
    FOR r_nv IN c_nv
    LOOP
      V_INSERT := ' ';
      V_INSERT := V_SQL;
      -- Lay nghiep vu
      V_INSERT := REPLACE(V_INSERT, 'LOAI_NV', Chr(39) || r_nv.ma_nghiepvu || Chr(39));
      -- Chuyen doi dieu kien so tien lay Dr - Cr hoac Cr - Dr ... tu bang DM_NghiepVu
      V_INSERT := REPLACE(V_INSERT, 'DR_CR', r_nv.DR_CR);
      -- Chuyen doi dieu kien tu cong thuc lay trong bang DM_NghiepVu
      V_INSERT := V_INSERT || ' And (' || FNC_CONVERT_FORMULA_FROM_TAB(r_nv.CONG_THUC) || ')';
      -- Lay them dieu kien tu bang DM_NghiepVu
      V_INSERT := V_INSERT || ' And ' || r_nv.Dieu_Kien;
      -- Thuc thi cau lenh
      --DBMS_OUTPUT.PUT_LINE(V_INSERT);
      EXECUTE Immediate V_INSERT;
    END LOOP;
  ELSE
    NULL;
  END CASE;
END;
END STC_PA_SYS;