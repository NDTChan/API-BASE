create or replace PACKAGE BODY STC_PHB AS
    FUNCTION Func_GetAnalyzeReport_B03H(MA_CHUONG NVARCHAR2,NAM NUMBER,KY NUMBER,LOAI_KHOAN NVARCHAR2,IsUnitReport NUMBER)
        RETURN GetAnalyzeReport_B03H_table
        PIPELINED IS
        rec  GetAnalyzeReport_B03H_record;
    BEGIN
        SELECT '621', 'AAA', '1', '2', '3', '','01','BBB','21',100000 INTO rec FROM DUAL;
        PIPE ROW (rec);
        RETURN;
    END Func_GetAnalyzeReport_B03H;
    
    /*UNITREPORT : tong hop theo don vi*/
    FUNCTION Func_GetSumReport_B03H(MACHUONG NVARCHAR2,NAM NUMBER,KY NUMBER,LOAIKHOAN NVARCHAR2,UNITREPORT number)
        RETURN GetSumReport_B03H_table
        AS
        rs_table  GetSumReport_B03H_table;
        HDTX NVARCHAR2(15);
        HDSXCungUngDV NVARCHAR2(15);
        HDNNDatHang NVARCHAR2(15);
        LOAIKHOAN_LENGTH NUMBER;
    BEGIN
        HDTX:='1%';HDSXCungUngDV:='2%';HDNNDatHang:='3%';
        
        IF (LOAIKHOAN = '') THEN LOAIKHOAN_LENGTH := 3;
        ELSE LOAIKHOAN_LENGTH := LENGTH(LOAIKHOAN); 
        END IF;
        
        SELECT CAST (MULTISET(
        SELECT 
        (CASE MACHUONG WHEN TO_NCHAR('-1') THEN B03H.MA_CHUONG ELSE MACHUONG END) AS MA_CHUONG,
        DMC.TEN_CHUONG,
        B03HD.MA_LOAI,
        CASE UNITREPORT
            WHEN 0 THEN SUBSTR(B03HD.MA_KHOAN,1,LOAIKHOAN_LENGTH)
            ELSE B03HD.MA_KHOAN
        END,
        B03HD.MA_CHI_TIEU,
        B03HD.TEN_CHI_TIEU,
        B03HD.STT_CHI_TIEU,
        SUM(NVL(B03HD.SO_TIEN, 0)) AS SO_TIEN,
        ( CASE WHEN B03HD.HOATDONG_ID LIKE HDTX          THEN SUM(NVL(B03HD.SO_TIEN, 0))ELSE 0 END) AS HOATDONG_ID1,
        ( CASE WHEN B03HD.HOATDONG_ID LIKE HDSXCungUngDV THEN SUM(NVL(B03HD.SO_TIEN, 0))ELSE 0 END ) AS HOATDONG_ID2,
        ( CASE WHEN B03HD.HOATDONG_ID LIKE HDNNDatHang   THEN SUM(NVL(B03HD.SO_TIEN, 0))ELSE 0 END ) AS HOATDONG_ID3
        FROM 
        PHB_B03H B03H INNER JOIN PHB_B03H_DETAIL B03HD ON B03H.REFID=B03HD.PHB_B03H_REFID
        INNER JOIN DM_CHUONG DMC ON DMC.MA_CHUONG = (CASE MACHUONG WHEN TO_NCHAR('-1') THEN B03H.MA_CHUONG ELSE MACHUONG END)
        INNER JOIN SYS_DVQHNS DVQHNS ON B03H.MA_QHNS=DVQHNS.MA_DVQHNS
        WHERE   (KY=-1 OR B03H.KY_BC=KY) 
            AND (NAM=-1 OR B03H.NAM_BC=NAM)
            AND (MACHUONG='-1' OR UNITREPORT=0 OR (B03H.MA_CHUONG=MACHUONG AND UNITREPORT=1)) 
            AND (LOAIKHOAN='-1' OR SUBSTR(B03HD.MA_KHOAN,1,LOAIKHOAN_LENGTH)=LOAIKHOAN)
            AND (B03HD.HOATDONG_ID LIKE HDTX OR B03HD.HOATDONG_ID LIKE HDSXCungUngDV OR B03HD.HOATDONG_ID LIKE HDNNDatHang)
        GROUP BY B03HD.HOATDONG_ID,
                    B03H.MA_CHUONG,
                    DMC.TEN_CHUONG,
                    B03HD.MA_CHI_TIEU,
                    B03HD.TEN_CHI_TIEU,
                    B03HD.STT_CHI_TIEU 
        ) AS GetSumReport_B03H_table ) INTO rs_table FROM DUAL;
        RETURN rs_table;
    END Func_GetSumReport_B03H;
END;