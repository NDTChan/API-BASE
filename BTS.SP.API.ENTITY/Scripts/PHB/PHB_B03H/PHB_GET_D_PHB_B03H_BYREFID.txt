create or replace PROCEDURE PHB_GET_D_PHB_B03H_BYREFID
(
  REF_ID IN NVARCHAR2,
  cur OUT SYS_REFCURSOR
)AS
BEGIN
Open cur for 
SELECT STT_CHI_TIEU,TEN_CHI_TIEU,MA_CHI_TIEU,SUM(HOATDONG_ID1) AS HOATDONG_ID1,SUM(HOATDONG_ID2) AS HOATDONG_ID2,SUM(HOATDONG_ID3) AS HOATDONG_ID3,
SUM(HOATDONG_ID4) AS HOATDONG_ID4,SUM(HOATDONG_ID5) AS HOATDONG_ID5,SUM(HOATDONG_ID1 + HOATDONG_ID2 +HOATDONG_ID3 +HOATDONG_ID4 +HOATDONG_ID5) AS TONG_CONG,CONG_THUC FROM
(SELECT  
B03HD.MA_CHI_TIEU,
B03HD.TEN_CHI_TIEU,
B03HD.STT_CHI_TIEU,
NVL((CASE WHEN B03HD.HOATDONG_ID =1  THEN NVL(B03HD.SO_TIEN, 0) END),0) AS HOATDONG_ID1,
NVL((CASE WHEN B03HD.HOATDONG_ID =2  THEN NVL(B03HD.SO_TIEN, 0) END),0) AS HOATDONG_ID2,
NVL((CASE WHEN B03HD.HOATDONG_ID =3  THEN NVL(B03HD.SO_TIEN, 0) END),0) AS HOATDONG_ID3,
NVL((CASE WHEN B03HD.HOATDONG_ID =4  THEN NVL(B03HD.SO_TIEN, 0) END),0) AS HOATDONG_ID4,
NVL((CASE WHEN B03HD.HOATDONG_ID =5  THEN NVL(B03HD.SO_TIEN, 0) END),0) AS HOATDONG_ID5,
B03HD.CONG_THUC AS CONG_THUC
FROM PHB_B03H B03H,PHB_B03H_DETAIL B03HD
WHERE   B03H.REFID=REF_ID AND B03H.REFID=B03HD.PHB_B03H_REFID
        ) GROUP BY MA_CHI_TIEU,TEN_CHI_TIEU,STT_CHI_TIEU,CONG_THUC ORDER BY MA_CHI_TIEU;
END PHB_GET_D_PHB_B03H_BYREFID;