create or replace PROCEDURE PHB_B06H_SummaryData
(
  MACHUONG IN NVARCHAR2,
  NAMBC IN NUMBER,
  KYBC IN NUMBER,
  cur OUT SYS_REFCURSOR
)AS
/*
Lấy dữ liệu báo cáo của các đơn vị để sinh báo cáo tổng hợp
Proc_Get_B06H_For_GenerateSummaryData
*/
BEGIN
Open cur for 
SELECT 
B06HD.PHAN,
B06HD.MA_CHI_TIEU,
B06HD.MA_LOAI,
B06HD.MA_KHOAN,
B06HD.STT_CHI_TIEU,
B06HD.TEN_CHI_TIEU,
B06HD.MA_SO,
NVL(B06HD.CONG_THUC,'') AS CONG_THUC,
SUM(B06HD.SODU_DAUNAM) AS SODU_DAUNAM,SUM(B06HD.SODU_CUOINAM) AS SODU_CUOINAM,
SUM(B06HD.QUY_KHENTHUONG) AS QUY_KHENTHUONG,SUM(B06HD.QUY_PHUCLOI) AS QUY_PHUCLOI,SUM(B06HD.QUY_KHAC) AS QUY_KHAC,SUM(B06HD.QUY_TONGSO)AS QUY_TONGSO,
SUM(B06HD.SO_PHAI_NOP_NAMTRUOC) AS SO_PHAI_NOP_NAMTRUOC,SUM(B06HD.SO_PHAI_NOP) AS SO_PHAI_NOP,SUM(B06HD.SO_DA_NOP) AS SO_DA_NOP,SUM(B06HD.SO_CON_PHAI_NOP) AS SO_CON_PHAI_NOP,
SUM(B06HD.DUTOAN_NAMTRUOC) AS DUTOAN_NAMTRUOC,SUM(B06HD.DUTOAN_GIAO_TRONGNAM) AS DUTOAN_GIAO_TRONGNAM,SUM(B06HD.DUTOAN_RUT_KHOBAC) AS DUTOAN_RUT_KHOBAC,
SUM(B06HD.DUTOAN_LENHCHI)AS DUTOAN_LENHCHI,SUM(B06HD.DUTOAN_GHITHUGHICHI)AS DUTOAN_GHITHUGHICHI,SUM(B06HD.DUTOAN_NGUONKHAC)AS DUTOAN_NGUONKHAC,SUM(B06HD.DUTOAN_HUY)AS DUTOAN_HUY,
SUM(B06HD.NGUONPHI_LEPHI) AS NGUONPHI_LEPHI,
SUM(B06HD.PHI_TIEPNHAN) AS PHI_TIEPNHAN,
SUM(B06HD.SO_TIEN) AS SO_TIEN,
(CASE WHEN B06HD.MA_CHI_TIEU ='019' THEN TO_CHAR(B06HD.NOI_DUNG) ELSE TO_CHAR(SUM(CASE WHEN B06HD.MA_CHI_TIEU='019' THEN 0 ELSE NVL(COALESCE(TO_NUMBER(REGEXP_SUBSTR(B06HD.NOI_DUNG,'^(-|+)?\d+(\.|,)?(\d+)?$')), 0),0) END)) END)AS NOI_DUNG,
B06HD.INDAM,
B06HD.INNGHIENG,
B06HD.INPUT
FROM PHB_B06H B06H
INNER JOIN PHB_B06H_DETAIL B06HD ON B06HD.PHB_B06H_REFID=B06H.REFID
INNER JOIN PHB_DM_DVQHNS DVQHNS ON B06H.MA_QHNS=DVQHNS.MA_QHNS
WHERE DVQHNS.TRANG_THAI='A' 
AND DVQHNS.DON_VI_TONG_HOP=0
AND (B06H.MA_CHUONG = CASE MACHUONG WHEN u'-1' THEN B06H.MA_CHUONG ELSE MACHUONG END ) 
AND (B06H.NAM_BC=CASE NAMBC WHEN -1 THEN B06H.NAM_BC ELSE NAMBC END)
AND (B06H.KY_BC=CASE KYBC WHEN -1 THEN B06H.KY_BC ELSE KYBC END)
GROUP BY B06HD.PHAN,
B06HD.MA_CHI_TIEU,
B06HD.MA_LOAI,
B06HD.MA_KHOAN,
B06HD.STT_CHI_TIEU,
B06HD.TEN_CHI_TIEU,
B06HD.MA_SO,CONG_THUC,
TO_CHAR(B06HD.NOI_DUNG),
B06HD.INDAM,
B06HD.INNGHIENG,
B06HD.INPUT
ORDER BY 
B06HD.PHAN,
B06HD.MA_LOAI,
B06HD.MA_KHOAN,
B06HD.MA_CHI_TIEU
;
END PHB_B06H_SummaryData;